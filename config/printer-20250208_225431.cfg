[include Macros.cfg]
[include speed.cfg]
[include tmc.cfg]
[include mainsail.cfg]
#[include adxl345_pico.cfg]
#[virtual_sdcard]
#path: /home/pi/Q51_data/gcodes
#on_error_gcode: CANCEL_PRINT

#[include adxl345_pico.cfg]  #Enable if you want to use ADXL with Rapsberry Pi Pico
#[include adxl345_fysetc.cfg]  #Enable if you want to use ADXL with Fysetc Portable Input Shaper
#[include timelapse.cfg]  #Enable if you want to use Timelapse
#[include neopixels.cfg]  #Enable if you want to use Neopixels

# This file contains common configurations and pin mappings
# for the Flsun QQ-S using the MKS Robin Nano board.
#
# To use this config, the firmware should be compiled for the
# STM32F103. When running "make menuconfig", enable "extra low-level
# configuration setup", select the 28KiB bootloader, and serial (on
# USART3 PB11/PB10) communication.

# Note that the "make flash" command does not work with MKS Robin
# boards. After running "make", run the following command:
# ./scripts/update_mks_robin.py out/klipper.bin out/Robin_nano.bin
# Copy the file out/Robin_nano.bin to an SD card and then restart the
# printer with that SD card.

[save_variables]
filename: /home/pi/printer_Q51_data/config/variables.cfg

[idle_timeout]
gcode: POWER_OFF_PRINTER
#   A list of G-Code commands to execute on an idle timeout. See
#   docs/Command_Templates.md for G-Code format. The default is to run
#   "TURN_OFF_HEATERS" and "M84".
timeout: 600
#   Idle time (in seconds) to wait before running the above G-Code
#   commands. The default is 600 seconds.

[delayed_gcode delayed_printer_off]
initial_duration: 60
gcode:
  {% if printer.idle_timeout.state == "Idle" %}
    POWER_OFF_PRINTER
  {% endif %}


#KLIPPER COMMANDS: ENDSTOP_PHASE_CALIBRATE stepper=stepper_(LETTER) REMOVE BRACKETS. PROBE_CALIBRATE DELTA_CALIBRATE (DO THIS AT PRINTING TEMP) SET FANS 40 PERCENT THEN PID_CALIBRATE HEATER=extruder TARGET=245
# SAVE_CONFG , PID_CALIBRATE HEATER=heater_bed TARGET=80, SAVE_CONFIG. your done. adjust slicer / retract accordingly. 
# OR RUN THE CALIBRATE MACRO MAKE SURE THE PROBE IS ON FOR ALL BED RELATED CALIBRATION INCLUDING Z OFFSET. NOTE FOR THE PAPER METHOD USE THE DEFAULTS IN KLIIPPER DOCS FOR #DELTA CALIBRATE / KINEMATICS REGARDING IT. 
# If the calibrate macro is used. run probe_calibrate first (aka zoffset) then run the macro. calibrate may need to be run 2x.
# Initially its safer to set the zoffset in fluidd/mainsaill a bit higher eg .2mmm or so then lower to 0 while printing a flat square or circle. This is a good safety measure to avoid a slight collison. 
############################################################################################################################################################
##MACHINE ABSOLUTE LIMITS / MOTION CONTROL / CONNECTED MCUS#/  ADD A # TO DISABLE MCU IF YOU DON'T HAVE ADXL OR PACKAGES INSTALLED 
############################################################################################################################################################
[printer]
kinematics: delta
max_velocity: 200
max_accel: 1000  #Marlin=1000 otherwise 1500 #5600  #3000-9000-20000 after tuning with adxl / inputshaper stay to lower values otherwise starting out. eg 6000 note marlin default is 2800 this may work better on some printers or filament types 
minimum_cruise_ratio: 0.5
#max_accel_to_decel: 1300 #2800 #I AM HALF MAX SET ACC BY DEFAULT. I CONTROL ZIG ZAG MOVEMENTS AND ADJUST VELOCITY BASED ON DIMENSIONS AND SMOOTH THINGS OUT. SET TO MAX WOULD BE SIMILAR TO MARLIN BEHAVIOR ADXL WIL COVER ROUGH MOVEMENTS. INCREASING MAX ACC IS USUALLY THE BETTER SOLUTION. 
#max_z_accel: 1500 # this default should be fine / max acceration for z moves. (It may help to bump this up or down a bit depending on desired noise / zhop height. 
minimum_z_position: -25
#square_corner_velocity: 5 # This can depend on desired speed to quality. higher values 15 -20 generally work fine. Left as a safe default. acc / corner velcoity can be adjusted with slicer controls macros handle this. i use a default of 15-30 or dynamic values. 
#delta_radius: 105
print_radius: 100
############################################################################################################################################################
#MAINBOARD / ACCELEROMETER SECTION.
############################################################################################################################################################
[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32f103xe_31FFD1054242363120762557-if00
restart_method: command
baud: 250000
############################################################################################################################################################
# A (X-Stepper) Configuration  ENABLE ARM LENGTH , ANGLE , POSITION ENDSTOP. FOR THE FIRST TIME EVER. DELTA CALIBRATE WILL ADJUST THIS AND SAVE AT THE BOTTOM. 
############################################################################################################################################################
[stepper_a] # X
step_pin: PB13
dir_pin: PB12
enable_pin: !PB14
microsteps: 32 # TMC ARE MENT TO BE SET TO THE HIGHEST VALUE THE MCU CAN SUPPORT THIS DOES NOT WORK THE SAME AS OLDER DRIVERS.  DON'T TOUCH ROTATION DISTANCE JUST THIS IF YOU WANT TO CHANGE IT (KLIPPER WILL CALCULATE STEPPING AUTOMATICALLY) 
rotation_distance: 40 #NEVER ADJUST THESE VALUES. ADJUSTING THIS WILL NOT SOLVE DIMENSION ISSUES. HORIZONTAL OFFSET / FLOW. OTHERWISE BELTS, OR RAILS MAY NOT BE MOVING RIGHT FOR THIS TO HAPPEN.  
full_steps_per_rotation: 200 #CHANGE THIS TO 400 FOR 0.9 DEGREE STEPPERS AGAIN KLIIPPER WILL CALCULATE THE NEW VALUES AUTOMATICALLY 
endstop_pin: ^PC0
homing_speed: 30 # This is left a bit slow for initial start up safty once everything is setup up 70-90 are reasonable. (note the sr has optical endstops it can home fast This value needs to be changed on a,b,c steppers)
second_homing_speed: 2
homing_retract_dist: 5.0
homing_retract_speed:10
#arm_length: 215
#position_endstop: 210 #note turning this one applys for b and c as well. 
#angle: 210
############################################################################################################################################################
# B (Y-Stepper)  Configuration 
############################################################################################################################################################
[stepper_b] # Y
step_pin: PB10
dir_pin: PB2
enable_pin: !PB11
microsteps: 32
rotation_distance: 40
full_steps_per_rotation: 200
endstop_pin: ^PC1
#angle: 330
############################################################################################################################################################
# C (Z-Stepper)  Configuration
############################################################################################################################################################
[stepper_c] # Z
step_pin: PB0
dir_pin: PC5
enable_pin: !PB1
microsteps: 32
rotation_distance: 40
full_steps_per_rotation: 200
endstop_pin: ^PC2
#angle: 90
############################################################################################################################################################
# Extruder Configuration
############################################################################################################################################################
[extruder]
step_pin: PB3
dir_pin: !PB4
enable_pin: !PD2
microsteps: 16
#gear_ratio: 50:17	# CHANGE THIS TO WHAT APPLIES TO CUSTOM EXTRUDER THIS IS FOR TITAN STOCK  
rotation_distance: 7.635  #23.26 #DEFAULT VALUE GET THIS FROM THE TITAN HOB GEAR. MEASURE THE HOB ON THE LEVER THAT VALUE x 3.14 = ROTATION DISTANCE. FLOW IN SLICER SHOULD BE WITHIN 10 PERCENT UP OR DOWN. FILAMENT TOLERANCE AND DENSITY WILL AFFECT FLOW ACTUAL FLOW. ull_steps_per_rotation: 200 #CHANGE ME TO 400 FOR 0.9 DEGREE Steppers  ROTATION DISTANCE WILL AUTOMATICALLY BE CALIBRATED THIS APPLYS TO STEPPING AS WELL NO CHANGES REQUIRED. 
full_steps_per_rotation: 200 #CHANGE ME TO 400 FOR 0.9 DEGREE Steppers  ROTATION DISTANCE WILL AUTOMATICALLY BE CALIBRATED THIS APPLYS TO STEPPING AS WELL NO CHANGES REQUIRED. 
nozzle_diameter: 0.600
filament_diameter: 1.750
heater_pin: PC8
sensor_type: Generic 3950 #EPCOS 100K B57560G104F #ATC Semitec 104GT-2 #EPCOS 100K B57560G104F #Default Stock/  NTC 100K beta 3950 #reently fixed in latest klipper beta 3950 is dead. don't try to use a older version since the temp table is wrong by 15c. 
sensor_pin: PA0
max_extrude_only_distance: 3500
control = pid
pid_kp = 38.469
pid_ki = 2.882
pid_kd = 128.390
min_temp: 0
max_temp: 300 #this value is set high for the purpose of hot tightening the hotend. stock hotends / tubes will degrade rappidly past 245. burning ptfe is also a neurotoxin. 
#max_extrude_only_accel: 1250 #8300 #BMG/TITAN
#max_extrude_only_velocity: 120 #120.0 #BMG/TITAN
#max_extrude_cross_section: 70 #BMG/TITAN
############################################################################################################################################################
# Bed Configuration
############################################################################################################################################################
[heater_bed]
heater_pin: PC9
sensor_type: EPCOS 100K B57560G104F #Stock /NTC 100K beta 3950
sensor_pin: PC3
min_temp: 0
max_temp: 130
control = pid
pid_kp = 74.688
pid_ki = 1.831
pid_kd = 761.821
############################################################################################################################################################
#COOLING SECTION 
############################################################################################################################################################
[fan]       # Part Cooling
pin: PA8
			  
############################################################################################################################################################
#AUTO BED LEVELING / DELTA CALIBRATE / MESH SETTINGS / OFFSETS. Note bed tilt and bed mesh are not compatible enabled at the same time. tilt reccomended. 
############################################################################################################################################################
[delta_calibrate]
radius: 90
horizontal_move_z: 30
speed: 30

[bed_mesh]  
speed: 50 
horizontal_move_z: 30 #This value is related to the lift height of the nozzle during bed_mesh
mesh_radius: 90
mesh_origin: 0,0  
round_probe_count: 9 # 7*7
algorithm: bicubic

[probe]
pin: ^!PC12 #Z_MIN
x_offset: -4 # -8.65
y_offset: -4 #-5.38
#z_offset: 0 # THIS WILL ONLY BE APPLIED AFTER A DELTA CALIBRATE HAS BEEN RUN SINCE DELTA DOESN'T CONSIDER A PROBE AS A ENDSTOP. IT USES THE 3 OPTICAL FOR THIS AND APPLYS THIS VALUES AFTER DELTACALIBRATES RUN. 
#lift_speed: 50 #The speed the probe raises before traveling or pobeing again.  
#speed: 5 #zprobing speed
#samples: 3 #depending on the machine /probe this may work with only 1 the calibrate macro already adds redundency. INCREASE THIS IF DELTA CALIBRATE SEEMS UNRELIABLE. 
samples_result: average
sample_retract_dist: 3
samples_tolerance: 0.03 #or #0.05 #This will depend how accurate probe is try for 0.02. 
samples_tolerance_retries: 5
############################################################################################################################################################
############################################################################################################################################################
########################################
# Temperature Controls
########################################
[temperature_sensor raspberry_pi]
sensor_type: temperature_host
min_temp: 10
max_temp: 100
[temperature_sensor mcu_temp]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100    
########################################
# Firmware Retraction Settings
########################################
[firmware_retraction]
retract_length: 2.45
retract_speed: 40
unretract_extra_length: 0
unretract_speed: 40
########################################
# Input Shaper Settings
########################################
[input_shaper]
shaper_type_x = mzv
shaper_freq_x = 107.8
shaper_type_y = mzv
shaper_freq_y = 95.8
########################################
# G-Code Macros & Events
########################################
[gcode_arcs]
[display_status]
[static_digital_output usb_pullup_enable]
pins: !PC13
[exclude_object]
########################################
[endstop_phase stepper_a]
endstop_align_zero: false

[endstop_phase stepper_b]
endstop_align_zero: false

[endstop_phase stepper_c]
endstop_align_zero: false 
########################################


############################################################################################################################################################  
#####################################
##            Set Material         ##
##      Version 1.0  2023-4-2      ##
#####################################

## Set Material-specific Configs
## 
## Add this immediately after your start_print line of the start gcode in Prusa/SuperSlicer:
##     SET_MATERIAL MATERIAL='{filament_type[initial_extruder]}'
## 
## Add this immediately after your start_print line of the start gcode in Cura:
##     SET_MATERIAL MATERIAL='{material_type}'
## 
[gcode_macro SET_MATERIAL]
gcode:
    {% set MATERIAL = params.MATERIAL|default('PLA')|string %}
    {% if MATERIAL == 'PLA' %}
        # Set pressure_advance settings
        M221 S95 #S84.3 #1mm S83.4  #0.4nozzle S97.41 
        SET_GCODE_OFFSET Z=0.3
        SET_PRESSURE_ADVANCE ADVANCE=0.45 SMOOTH_TIME=0.040
        BED_MESH_PROFILE LOAD="default"  
        set_retraction RETRACT_LENGTH=1.95000 RETRACT_SPEED=40.00000 UNRETRACT_EXTRA_LENGTH=0.00000 UNRETRACT_SPEED=40.00000
    {% elif MATERIAL == 'PLA-Elegoo' %}
        M221 S95
        BED_MESH_PROFILE LOAD="default" ; Load bed mesh
        SET_PRESSURE_ADVANCE ADVANCE=0.45 SMOOTH_TIME=0.040 ; Set pressure_advance settings
        SET_GCODE_OFFSET Z=0.3; Set z_offset
        set_retraction RETRACT_LENGTH=1.95000 RETRACT_SPEED=40.00000 UNRETRACT_EXTRA_LENGTH=0.00000 UNRETRACT_SPEED=40.00000
    {% elif MATERIAL == 'TPU' %}
        M221 S97
        BED_MESH_PROFILE LOAD="40" ; Load bed mesh
        SET_PRESSURE_ADVANCE ADVANCE=0.600 SMOOTH_TIME=0.040 ; Set pressure_advance settings
        SET_GCODE_OFFSET Z=0 ; Set z_offset      
    {% elif MATERIAL == 'PETG' %}
        M221 S98 #110 #84.65
        SET_GCODE_OFFSET Z=0.00
        SET_PRESSURE_ADVANCE ADVANCE=0.550 SMOOTH_TIME=0.040 #to invesitgate vs Q5-2
        BED_MESH_PROFILE LOAD="70"
    {% elif MATERIAL == 'ASA' %}
        M221 S94 #110 #84.65
        SET_GCODE_OFFSET Z=0.35
        SET_PRESSURE_ADVANCE ADVANCE=0.620 SMOOTH_TIME=0.040 #to invesitgate vs Q5-2
        BED_MESH_PROFILE LOAD="100"        
        set_retraction RETRACT_LENGTH=1.50000 RETRACT_SPEED=60.00000 UNRETRACT_EXTRA_LENGTH=0.00000 UNRETRACT_SPEED=60.00000
    {%else %}
        BED_MESH_PROFILE LOAD="default"
        SET_PRESSURE_ADVANCE ADVANCE=0.425 SMOOTH_TIME=0.040
        SET_GCODE_OFFSET Z=-0.35
    {% endif %}

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [endstop_phase stepper_a]
#*# trigger_phase = 104/128
#*#
#*# [endstop_phase stepper_b]
#*# trigger_phase = 82/128
#*#
#*# [endstop_phase stepper_c]
#*# trigger_phase = 25/128
#*#
#*# [probe]
#*# z_offset = 15.140
#*#
#*# [printer]
#*# delta_radius = 107.543373
#*#
#*# [stepper_a]
#*# angle = 210.891030
#*# arm_length = 217.487302
#*# position_endstop = 211.066555
#*#
#*# [stepper_b]
#*# angle = 330.835744
#*# arm_length = 214.728867
#*# position_endstop = 209.998399
#*#
#*# [stepper_c]
#*# angle = 90.000000
#*# arm_length = 217.400768
#*# position_endstop = 211.331745
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	-0.336716, -0.336716, -0.336716, -0.336716, -0.336716, -0.336716, -0.336716, -0.336716, -0.336716
#*# 	-0.102161, -0.102161, -0.102161, -0.114679, -0.158044, -0.217985, -0.217988, -0.217988, -0.217988
#*# 	0.007248, 0.007248, -0.017153, -0.062584, -0.081648, -0.112877, -0.133152, -0.177236, -0.177236
#*# 	0.036412, 0.036412, 0.044808, 0.017331, -0.032711, -0.036183, 0.067300, 0.089077, 0.089077
#*# 	-0.036943, 0.011002, 0.038598, 0.037415, 0.043419, 0.092958, 0.139758, 0.095303, 0.044704
#*# 	-0.097827, -0.097827, -0.042164, -0.018530, -0.006454, -0.019338, -0.055560, -0.131489, -0.131489
#*# 	-0.124504, -0.124504, -0.095367, -0.029732, 0.000205, 0.000406, -0.038955, -0.151358, -0.151358
#*# 	-0.062128, -0.062128, -0.062128, 0.018803, 0.080130, -0.051354, -0.093974, -0.093974, -0.093974
#*# 	0.108483, 0.108483, 0.108483, 0.108483, 0.108483, 0.108483, 0.108483, 0.108483, 0.108483
#*# x_count = 9
#*# y_count = 9
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = -90.0
#*# max_x = 90.0
#*# min_y = -90.0
#*# max_y = 90.0
#*#
#*# [delta_calibrate]
#*# height0 = 15.156
#*# height0_pos = 31291.000,31291.000,31291.000
#*# height1 = 15.156
#*# height1_pos = 39281.000,39281.000,27026.000
#*# height2 = 15.156
#*# height2_pos = 30487.000,44069.000,30487.000
#*# height3 = 15.156
#*# height3_pos = 27182.000,37919.000,37919.000
#*# height4 = 15.156
#*# height4_pos = 30090.000,30090.000,39749.000
#*# height5 = 15.156
#*# height5_pos = 36532.000,27217.000,36532.000
#*# height6 = 15.156
#*# height6_pos = 41650.000,30163.000,30163.000
#*# distance0 = 64.94999999999999
#*# distance0_pos1 = 33402.140,33732.700,34046.995
#*# distance0_pos2 = 29775.169,39363.281,39656.926
#*# distance1 = 65.60000000000001
#*# distance1_pos1 = 33608.113,33320.018,34255.500
#*# distance1_pos2 = 32735.366,32438.533,44009.554
#*# distance2 = 65.30000000000001
#*# distance2_pos1 = 34020.801,33114.667,34046.995
#*# distance2_pos2 = 39662.760,29487.658,39656.926
#*# distance3 = 65.38
#*# distance3_pos1 = 34227.527,33317.760,33634.326
#*# distance3_pos2 = 43981.470,32404.679,32737.024
#*# distance4 = 65.15
#*# distance4_pos1 = 34017.250,33730.412,33430.103
#*# distance4_pos2 = 39595.109,39319.674,29803.068
#*# distance5 = 65.0
#*# distance5_pos1 = 33604.610,33940.060,33634.326
#*# distance5_pos2 = 32682.844,43694.068,32737.024
#*# distance6 = 65.39
#*# distance6_pos1 = 29991.066,38154.730,39193.819
#*# distance6_pos2 = 33013.800,32118.938,43512.482
#*# distance7 = 65.26
#*# distance7_pos1 = 32968.659,32075.272,42553.395
#*# distance7_pos2 = 39761.343,29557.950,38997.534
#*# distance8 = 64.94
#*# distance8_pos1 = 39194.710,29700.989,38450.759
#*# distance8_pos2 = 43481.795,32682.723,32418.686
#*# distance9 = 65.27
#*# distance9_pos1 = 42522.839,32640.464,32376.126
#*# distance9_pos2 = 38936.626,39421.644,29874.364
#*# distance10 = 64.71
#*# distance10_pos1 = 38392.650,38859.748,30017.408
#*# distance10_pos2 = 32366.457,43198.679,33015.223
#*# distance11 = 64.9
#*# distance11_pos1 = 32325.608,42239.521,32971.837
#*# distance11_pos2 = 29848.019,38703.309,39757.572
#*#
#*# [bed_mesh 100]
#*# version = 1
#*# points =
#*# 	-0.250870, -0.250870, -0.250870, -0.250870, -0.250870, -0.250870, -0.250870, -0.250870, -0.250870
#*# 	-0.050804, -0.050804, -0.050804, -0.069552, -0.050673, -0.155275, -0.146345, -0.146345, -0.146345
#*# 	0.003645, 0.003645, 0.063566, 0.006539, 0.051177, 0.011870, -0.029562, -0.042128, -0.042128
#*# 	0.145579, 0.145579, 0.142810, 0.136430, 0.093966, 0.082173, 0.117333, 0.205796, 0.205796
#*# 	0.031390, 0.182052, 0.225061, 0.231195, 0.191792, 0.217975, 0.255105, 0.244109, 0.203302
#*# 	0.131854, 0.131854, 0.262013, 0.255194, 0.231960, 0.173664, 0.267754, 0.211220, 0.211220
#*# 	0.113196, 0.113196, 0.226224, 0.236115, 0.230581, 0.294055, 0.269256, 0.212577, 0.212577
#*# 	0.132151, 0.132151, 0.132151, 0.193029, 0.168660, 0.168577, 0.186259, 0.186259, 0.186259
#*# 	0.188058, 0.188058, 0.188058, 0.188058, 0.188058, 0.188058, 0.188058, 0.188058, 0.188058
#*# x_count = 9
#*# y_count = 9
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = -90.0
#*# max_x = 90.0
#*# min_y = -90.0
#*# max_y = 90.0
#*#
#*# [bed_mesh 70]
#*# version = 1
#*# points =
#*# 	  -0.350870, -0.350870, -0.350870, -0.350870, -0.350870, -0.350870, -0.350870, -0.350870, -0.350870
#*# 	  -0.213304, -0.213304, -0.213304, -0.232052, -0.206923, -0.261525, -0.221345, -0.221345, -0.221345
#*# 	  -0.096355, -0.096355, -0.086434, -0.093461, -0.092573, -0.125630, -0.179562, -0.204628, -0.204628
#*# 	  0.008079, 0.008079, -0.038440, -0.013570, -0.068534, -0.092827, -0.038917, -0.000454, -0.000454
#*# 	  -0.149860, 0.019552, 0.025061, 0.018695, 0.010542, 0.074225, 0.086355, 0.044109, 0.015802
#*# 	  -0.068146, -0.068146, 0.068263, 0.092694, 0.025710, -0.007586, 0.086504, 0.004970, 0.004970
#*# 	  -0.130554, -0.130554, 0.001224, 0.086115, 0.074331, 0.162805, 0.094256, 0.006327, 0.006327
#*# 	  -0.117849, -0.117849, -0.117849, 0.018029, -0.037590, -0.037673, -0.013741, -0.013741, -0.013741
#*# 	  -0.005692, -0.005692, -0.005692, -0.005692, -0.005692, -0.005692, -0.005692, -0.005692, -0.005692
#*# x_count = 9
#*# y_count = 9
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = -90.0
#*# max_x = 90.0
#*# min_y = -90.0
#*# max_y = 90.0
