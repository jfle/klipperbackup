# Orbiter v2.0 Filament Sensor Configuration for Klipper
# Delta printer, direct drive, community macros baseline

[filament_switch_sensor orbiter_sensor]
pause_on_runout: False  # Handled in macro
switch_pin: ^!PA1  # <-- Replace with your actual sensor pin
# For example: ^!PC15 or ^!PB1 depending on board wiring
#pullup: True
#input_pullup_resistor: True
triggered_only: False
runout_gcode: 
    RUNOUT_HANDLER

# ====================
# Macro: RUNOUT_HANDLER
# ====================
[gcode_macro RUNOUT_HANDLER]
description: Handles filament runout event safely
gcode:
    {% if printer.idle_timeout.state != "Printing" %}
        M118 Runout triggered, but not printing.
        RESPOND PREFIX="runout" MSG="Runout ignored (not printing)"
        SET_FILAMENT_STATUS NOFILAMENT=1
        ABORT
    {% endif %}
    {% if printer.pause_resume.is_paused %}
        M118 Runout triggered while already paused.
        RESPOND PREFIX="runout" MSG="Runout ignored (already paused)"
        ABORT
    {% endif %}
    SET_FILAMENT_STATUS NOFILAMENT=1
    PAUSE
    RESPOND PREFIX="runout" MSG="Runout detected and PAUSE issued"

# =========================
# Macro: SET_FILAMENT_STATUS
# =========================
[gcode_macro SET_FILAMENT_STATUS]
description: Sets internal state for filament (used in logic)
variable_NOFILAMENT: 0
gcode:
    {% set newstate = params.NOFILAMENT|int %}
    SET_GCODE_VARIABLE MACRO=SET_FILAMENT_STATUS VARIABLE=NOFILAMENT VALUE={newstate}

# ====================
# Macro: LOAD_FILAMENT
# ====================
[gcode_macro LOAD_FILAMENT]
description: Load filament manually into extruder
gcode:
    M118 Loading filament...
    G91
    G1 E40 F300  ; push filament gently
    G90
    SET_FILAMENT_STATUS NOFILAMENT=0
    RESPOND PREFIX="load" MSG="Filament loaded."

# ====================
# Macro: UNLOAD_FILAMENT
# ====================
[gcode_macro UNLOAD_FILAMENT]
description: Unload filament from extruder
gcode:
    M118 Unloading filament...
    G91
    G1 E-60 F900 ; retract fully
    G90
    SET_FILAMENT_STATUS NOFILAMENT=1
    RESPOND PREFIX="unload" MSG="Filament unloaded."

# ====================
# Macro: FILAMENT_PRESENT
# ====================
[gcode_macro FILAMENT_PRESENT]
description: Manually set filament as present (if sensor fails or is bypassed)
gcode:
    SET_FILAMENT_STATUS NOFILAMENT=0
    RESPOND PREFIX="sensor" MSG="Filament manually marked as present."

# ====================
# Macro: FILAMENT_NOT_PRESENT
# ====================
[gcode_macro FILAMENT_NOT_PRESENT]
description: Manually set filament as missing
gcode:
    SET_FILAMENT_STATUS NOFILAMENT=1
    RESPOND PREFIX="sensor" MSG="Filament manually marked as missing."

# Optional:
# You can add this to your PRINT_START to auto-check filament state
[gcode_macro CHECK_FILAMENT]
description: Checks if filament is present before print
gcode:
    {% if SET_FILAMENT_STATUS.NOFILAMENT == 1 %}
        RESPOND PREFIX="filament" MSG="No filament detected before print. Aborting."
        ABORT
    {% else %}
        M118 Filament present, proceeding...
    {% endif %}
