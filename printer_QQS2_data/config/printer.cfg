# This file contains common pin mappings for the BIGTREETECH SKR mini
# E3 v3.0. To use this config, the firmware should be compiled for the
# STM32G0B1 with a "8KiB bootloader" and USB communication.

# The "make flash" command does not work on the SKR mini E3. Instead,
# after running "make", copy the generated "out/klipper.bin" file to a
# file named "firmware.bin" on an SD card and then restart the SKR
# mini E3 with that SD card.

# See docs/Config_Reference.md for a description of parameters.

#[include mainsail.cfg]
# printer.cfg
#[include timelapse.cfg]
[include Macros.cfg]
[include tmc.cfg]
[include mainsail.cfg]
#[include filament.cfg]
#[include globals.cfg]
#[include speed.cfg]
#[include led_progress.cfg]
#[include printcfg.cfg]
#[include Adaptive_Mesh.cfg]
[include OrbiterSensor.cfg]
#[include adxl345_pico.cfg]
[idle_timeout]

gcode: POWER_OFF_PRINTER
#   A list of G-Code commands to execute on an idle timeout. See
#   docs/Command_Templates.md for G-Code format. The default is to run
#   "TURN_OFF_HEATERS" and "M84".
timeout: 600
#   Idle time (in seconds) to wait before running the above G-Code
#   commands. The default is 600 seconds.

[delayed_gcode delayed_printer_off]
initial_duration: 60
gcode:
  {% if printer.idle_timeout.state == "Idle" %}
    POWER_OFF_PRINTER
  {% endif %}



[printer]
kinematics: delta
max_velocity: 250
#max_z_velocity: 100 
max_accel: 5000 #2400
minimum_cruise_ratio: 0.5
square_corner_velocity: 5
#delta_radius: 135
print_radius: 130
minimum_z_position: -1
############################################################################################################################################################
#MAINBOARD / ACCELEROMETER SECTION.
############################################################################################################################################################
[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32g0b1xx_5300410002504B5735313920-if00
restart_method: command #rpi_usb #command
baud: 250000

############################################################################################################################################################
#NeoPixel LED
############################################################################################################################################################
[neopixel my_led]
pin: PA8
#   The pin connected to the neopixel. This parameter must be
#   provided.
chain_count: 5
#   The number of Neopixel chips that are "daisy chained" to the
#   provided pin. The default is 1 (which indicates only a single
#   Neopixel is connected to the pin).
color_order: GRB
#   Set the pixel order required by the LED hardware (using a string
#   containing the letters R, G, B, W with W optional). Alternatively,
#   this may be a comma separated list of pixel orders - one for each
#   LED in the chain. The default is GRB.
initial_RED: 1
initial_GREEN: 1
initial_BLUE: 1
initial_WHITE: 0
#   See the "led" section for information on these parameters.
############################################################################################################################################################
# A (X-Stepper) Configuration  ENABLE ARM LENGTH , ANGLE , POSITION ENDSTOP. FOR THE FIRST TIME EVER. DELTA CALIBRATE WILL ADJUST THIS AND SAVE AT THE BOTTOM. 
############################################################################################################################################################
[stepper_a]
step_pin: PB13
dir_pin: !PB12
enable_pin: !PB14
microsteps: 32 # TMC ARE MENT TO BE SET TO THE HIGHEST VALUE THE MCU CAN SUPPORT THIS DOES NOT WORK THE SAME AS OLDER DRIVERS.  DON'T TOUCH ROTATION DISTANCE JUST THIS IF YOU WANT TO CHANGE IT (KLIPPER WILL CALCULATE STEPPING AUTOMATICALLY) 
rotation_distance: 32 #NEVER ADJUST THESE VALUES. ADJUSTING THIS WILL NOT SOLVE DIMENSION ISSUES. HORIZONTAL OFFSET / FLOW. OTHERWISE BELTS, OR RAILS MAY NOT BE MOVING RIGHT FOR THIS TO HAPPEN.  
full_steps_per_rotation: 200 #CHANGE THIS TO 400 FOR 0.9 DEGREE STEPPERS AGAIN KLIIPPER WILL CALCULATE THE NEW VALUES AUTOMATICALLY 
endstop_pin: PC0 #tmc2209_stepper_a:virtual_endstop
homing_speed: 60
homing_retract_dist: 5
homing_retract_speed: 10
second_homing_speed: 2
#arm_length: 283.5 #note turning this one applys for b and c as well. 
#position_endstop: 341 #390 #note turning this one applys for b and c as well. 345
#angle: 210
############################################################################################################################################################
# B (Y-Stepper)  Configuration 
############################################################################################################################################################
[stepper_b]
step_pin: PB10
dir_pin: !PB2
enable_pin: !PB11
microsteps: 32
rotation_distance: 32
full_steps_per_rotation: 200
#position_endstop: 368 #390 #note turning this one applys for b and c as well. 345
endstop_pin: PC1 #tmc2209_stepper_b:virtual_endstop
#angle: 330
############################################################################################################################################################
# C (Z-Stepper)  Configuration
############################################################################################################################################################
[stepper_c]
step_pin: PB0
dir_pin: !PC5
enable_pin: !PB1
microsteps: 32
rotation_distance: 32
full_steps_per_rotation: 200
#position_endstop: 368 #390 #note turning this one applys for b and c as well. 345
endstop_pin: PC2 #tmc2209_stepper_c:virtual_endstop
#angle: 90
############################################################################################################################################################
# Extruder Configuration
############################################################################################################################################################
[extruder]
#max_extrude_cross_section: 5000
step_pin: PB3
dir_pin: PB4
enable_pin: !PD1
microsteps: 16
full_steps_per_rotation: 200
rotation_distance: 4.521 #4.637
nozzle_diameter: 0.400                             #define nozzle diameter
filament_diameter: 1.750
max_extrude_only_distance: 2200 # 500
max_extrude_only_velocity: 120
# instantaneous_corner_velocity: 10
max_extrude_only_accel: 2500
pressure_advance: 0.035 #0.025                         #to be calibrated
pressure_advance_smooth_time: 0.04     #to be calibrated
heater_pin: PC8
sensor_type: ATC Semitec 104NT-4-R025H42G #  # #Generic 3950 #ATC Semitec 104GT-2 #NTC 100K MGB18-104F39050L32 #EPCOS 100K B57560G104F #Generic 3950 #PT1000
#   Analog input pin connected to the sensor. This parameter must be
#   provided.
#pullup_resistor: 4700
#   The resistance (in ohms) of the pullup attached to the sensor. The
#   default is 4700 ohms.
sensor_pin: PA0
control = pid
pid_Kp: 23.140
pid_Ki: 11.867
pid_Kd: 29.781
min_temp: 0
max_temp: 340 #this value is set high for the purpose of hot tightening the hotend. stock hotends / tubes will degrade rappidly past 245. burning ptfe is also a neurotoxin. 
############################################################################################################################################################
# Bed Configuration
############################################################################################################################################################
[heater_bed]
heater_pin: PC9
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC4
control = pid
pid_kp = 73.812
pid_ki = 1.885
pid_kd = 722.438
min_temp: 0
max_temp: 130
############################################################################################################################################################
#COOLING SECTION 
############################################################################################################################################################
#[heater_fan heatbreak_cooling_fan]
#pin: PC6

[heater_fan controller_fan]
pin: PB15

[fan]
pin: PC7

############################################################################################################################################################
#AUTO BED LEVELING / DELTA CALIBRATE / MESH SETTINGS / OFFSETS. Note bed tilt and bed mesh are not compatible enabled at the same time. tilt reccomended. 
############################################################################################################################################################
[probe]
pin: ^PA15 #!PA15 #!PC15 #^PC15 #^!PC14
#deactivate_on_each_sample: False
x_offset: 0 # 2
y_offset: 0 #1 #-3.5 #-16.85 #-22.2
#z_offset: 0
lift_speed: 10 #The speed the probe raises before traveling or pobeing again.  
speed:10 #zprobing speed
samples: 5
samples_result: average
sample_retract_dist: 5
samples_tolerance: 0.025
samples_tolerance_retries: 11

[delta_calibrate]
# Bed radius 130 mm minus probe offset 4 mm = 126 mm
radius: 130
horizontal_move_z: 24

speed: 60

[bed_mesh]
speed: 45
horizontal_move_z: 24
# X spans full ±130 mm; Y spans ±(130–4)=±126 mm
mesh_radius: 120
mesh_origin: 0,0 
round_probe_count:11
algorithm: bicubic
bicubic_tension: 0.2

########################################
# Temperature Controls
########################################
[temperature_sensor raspberry_pi]
sensor_type: temperature_host
min_temp: 10
max_temp: 100
[temperature_sensor mcu_temp]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100    

########################################
# Firmware Retraction Settings
########################################
[firmware_retraction]
retract_length: 0.75 # 0.66
retract_speed: 100
unretract_extra_length: 0
unretract_speed: 100
########################################
# Input Shaper Settings
########################################
[input_shaper]
shaper_type_x = 3hump_ei
shaper_freq_x = 82.8
shaper_type_y = 2hump_ei
shaper_freq_y = 67.2
# G-Code Macros & Events
########################################
[gcode_arcs]
[display_status]
[static_digital_output usb_pullup_enable]
pins: !PC13
[exclude_object]
########################################
[endstop_phase stepper_a]
endstop_align_zero: false

[endstop_phase stepper_b]
endstop_align_zero: false

[endstop_phase stepper_c]
endstop_align_zero: false 
########################################
[board_pins]
# See the sample-lcd.cfg file for definitions of common LCD displays.
aliases:
    # EXP1 header
    EXP1_1=PB5,  EXP1_3=PA9,   EXP1_5=PA10, EXP1_7=PB8, EXP1_9=<GND>,
    EXP1_2=PA15, EXP1_4=<RST>, EXP1_6=PB9,  EXP1_8=PD6, EXP1_10=<5V>

############################################################################################################################################################  
#####################################
##            Set Material         ##
##      Version 1.0  2023-4-2      ##
#####################################

## Set Material-specific Configs
## 
## Add this immediately after your start_print line of the start gcode in Prusa/SuperSlicer:
##     SET_MATERIAL MATERIAL='{filament_type[initial_extruder]}'
## 
## Add this immediately after your start_print line of the start gcode in Cura:
##     SET_MATERIAL MATERIAL='{material_type}'
## 
[gcode_macro SET_MATERIAL]
gcode:
    {% set MATERIAL = params.MATERIAL|default('PLA')|string %}
    {% if MATERIAL == 'PLA' %}
        M221 S83
        BED_MESH_PROFILE LOAD="default" ; Load bed mesh
        SET_PRESSURE_ADVANCE ADVANCE=0.032 SMOOTH_TIME=0.030 ; Set pressure_advance settings
        SET_GCODE_OFFSET Z=-0.070 ; Set z_offset
        #SET_VELOCITY_LIMIT VELOCITY=100 ACCEL=1300 ; Set max speed/acceleration
        #SET_INPUT_SHAPER SHAPER_FREQ_X=23 SHAPER_FREQ_Y=23 SHAPER_TYPE_X=mzv SHAPER_TYPE_Y=mzv ; Set input_shaper
    {% elif MATERIAL == 'TPU' %}
        M221 S88
        BED_MESH_PROFILE LOAD="default" ; Load bed mesh
        SET_PRESSURE_ADVANCE ADVANCE=0.084 SMOOTH_TIME=0.040 ; Set pressure_advance settings
        SET_GCODE_OFFSET Z=0 ; Set z_offset
        SET_VELOCITY_LIMIT VELOCITY=100 ACCEL=700 ; Set max speed/acceleration
        #SET_INPUT_SHAPER SHAPER_FREQ_X=23 SHAPER_FREQ_Y=23 SHAPER_TYPE_X=mzv SHAPER_TYPE_Y=mzv ; Set input_shaper         
    {% elif MATERIAL == 'PETG' %}
        M221 S80.7
        BED_MESH_PROFILE LOAD="70" ; Load bed mesh
        SET_PRESSURE_ADVANCE ADVANCE=0.0850 SMOOTH_TIME=0.030 ; Set pressure_advance settings
        SET_GCODE_OFFSET Z=0.0 ; Set z_offset
        #set_retraction RETRACT_LENGTH=2.8 RETRACT_SPEED=120.00000 UNRETRACT_EXTRA_LENGTH=0.0000 UNRETRACT_SPEED=120.00000
    {% elif MATERIAL == 'ASA' %}
        M221 S93.4 #110 #84.65
        SET_GCODE_OFFSET Z=0.0
        SET_PRESSURE_ADVANCE ADVANCE=0.084 SMOOTH_TIME=0.040 #to invesitgate vs Q5-2
        BED_MESH_PROFILE LOAD="90"        
        #set_retraction RETRACT_LENGTH=1.650000 RETRACT_SPEED=40.00000 UNRETRACT_EXTRA_LENGTH=0.00000 UNRETRACT_SPEED=40.00000    
    {%else %} ; If any other material type
        BED_MESH_PROFILE LOAD="default" ; Load bed mesh
        SET_PRESSURE_ADVANCE ADVANCE=0.084 SMOOTH_TIME=0.040 ; Set pressure_advance settings
        SET_GCODE_OFFSET Z=0 ; Set z_offset
    {% endif %}

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*#
#*# [probe]
#*# z_offset = 12.852
#*#
#*# [endstop_phase stepper_a]
#*# trigger_phase = 24/128
#*#
#*# [endstop_phase stepper_b]
#*# trigger_phase = 39/128
#*#
#*# [endstop_phase stepper_c]
#*# trigger_phase = 75/128
#*#
#*# [printer]
#*# delta_radius = 149.524618
#*#
#*# [stepper_a]
#*# angle = 209.535576
#*# arm_length = 292.464068
#*# position_endstop = 343.358407
#*#
#*# [stepper_b]
#*# angle = 329.676278
#*# arm_length = 294.531154
#*# position_endstop = 342.516625
#*#
#*# [stepper_c]
#*# angle = 90.000000
#*# arm_length = 298.112038
#*# position_endstop = 341.522596
#*#
#*# [delta_calibrate]
#*# height0 = 12.852
#*# height0_pos = 65913.600,65913.600,65913.600
#*# height1 = 12.852
#*# height1_pos = 79936.800,79936.800,58052.800
#*# height2 = 12.852
#*# height2_pos = 64236.400,88957.400,64236.400
#*# height3 = 12.852
#*# height3_pos = 58559.400,77620.400,77620.400
#*# height4 = 12.852
#*# height4_pos = 63890.800,63890.800,81098.200
#*# height5 = 12.852
#*# height5_pos = 75445.200,58982.200,75445.200
#*# height6 = 12.852
#*# height6_pos = 84545.400,63906.400,63906.400
#*# distance0 = 66.77
#*# distance0_pos1 = 68026.679,68837.327,68638.243
#*# distance0_pos2 = 62546.933,75223.770,74984.882
#*# distance1 = 67.7
#*# distance1_pos1 = 68292.048,68295.159,68911.612
#*# distance1_pos2 = 66356.954,66440.455,80150.027
#*# distance2 = 66.23
#*# distance2_pos1 = 68834.142,68023.986,68638.243
#*# distance2_pos2 = 75122.103,62544.139,74984.882
#*# distance3 = 66.54
#*# distance3_pos1 = 69110.995,68290.464,68096.095
#*# distance3_pos2 = 80349.123,66370.632,66208.768
#*# distance4 = 67.18
#*# distance4_pos1 = 68841.126,68832.578,67827.266
#*# distance4_pos2 = 75246.283,75139.339,62347.332
#*# distance5 = 66.23
#*# distance5_pos1 = 68298.954,69108.318,68096.095
#*# distance5_pos2 = 66459.649,80346.600,66208.768
#*# distance6 = 66.2
#*# distance6_pos1 = 62947.289,73881.245,74568.536
#*# distance6_pos2 = 66761.886,66064.455,79636.636
#*# distance7 = 66.8
#*# distance7_pos1 = 66794.302,66090.883,78630.492
#*# distance7_pos2 = 75300.601,62676.194,74224.616
#*# distance8 = 67.36
#*# distance8_pos1 = 74714.318,62945.501,73646.302
#*# distance8_pos2 = 79840.267,66775.703,65835.267
#*# distance9 = 66.19
#*# distance9_pos1 = 78834.031,66807.061,65863.925
#*# distance9_pos2 = 74484.930,75316.636,62481.495
#*# distance10 = 66.28999999999999
#*# distance10_pos1 = 73901.907,74728.816,62750.818
#*# distance10_pos2 = 66082.474,79836.289,66614.126
#*# distance11 = 67.69
#*# distance11_pos1 = 66107.848,78830.078,66643.229
#*# distance11_pos2 = 62677.994,74462.761,75159.617
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	0.673580, 0.673580, 0.673580, 0.673580, 0.673580, 0.673580, 0.673580, 0.673580, 0.673580, 0.673580, 0.673580
#*# 	0.430754, 0.430754, 0.430754, 0.379640, 0.302428, 0.242535, 0.208407, 0.148943, 0.107659, 0.107659, 0.107659
#*# 	0.120032, 0.120032, 0.096706, 0.128071, 0.129105, 0.075484, 0.048239, 0.044487, -0.006576, -0.141883, -0.141883
#*# 	-0.062198, -0.062198, -0.040475, -0.004212, 0.053773, 0.028025, 0.028029, -0.052842, -0.091576, -0.237504, -0.237504
#*# 	-0.223969, -0.223969, -0.179652, -0.052793, 0.055226, 0.049693, 0.038091, -0.010527, -0.097485, -0.191581, -0.191581
#*# 	-0.222219, -0.279177, -0.191573, -0.043819, 0.073217, 0.074209, 0.039656, 0.006484, -0.127087, -0.260352, -0.251268
#*# 	-0.298792, -0.298792, -0.183103, -0.037648, 0.080441, 0.113471, 0.071322, 0.026182, -0.064205, -0.176705, -0.176705
#*# 	-0.194814, -0.194814, -0.136318, -0.032944, 0.081543, 0.145101, 0.125630, 0.026424, -0.051386, -0.113283, -0.113283
#*# 	-0.004652, -0.004652, -0.013921, 0.064029, 0.114454, 0.185913, 0.151989, 0.090600, 0.036019, 0.000743, 0.000743
#*# 	0.059592, 0.059592, 0.059592, 0.106292, 0.163108, 0.195553, 0.180470, 0.129104, 0.087437, 0.087437, 0.087437
#*# 	0.234690, 0.234690, 0.234690, 0.234690, 0.234690, 0.234690, 0.234690, 0.234690, 0.234690, 0.234690, 0.234690
#*# x_count = 11
#*# y_count = 11
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = -120.0
#*# max_x = 120.0
#*# min_y = -120.0
#*# max_y = 120.0
#*#
#*# [bed_mesh 70]
#*# version = 1
#*# points =
#*# 	0.721580, 0.721580, 0.721580, 0.721580, 0.721580, 0.721580, 0.721580, 0.721580, 0.721580, 0.721580, 0.721580
#*# 	0.501754, 0.501754, 0.501754, 0.429640, 0.343428, 0.306535, 0.238407, 0.212943, 0.160659, 0.160659, 0.160659
#*# 	0.192032, 0.192032, 0.124706, 0.165071, 0.143105, 0.123484, 0.080239, 0.053487, 0.013424, -0.142874, -0.142874
#*# 	-0.031198, -0.031198, -0.010475, 0.040788, 0.079773, 0.061025, 0.057029, 0.003381, -0.078576, -0.225504, -0.225504
#*# 	-0.177969, -0.177969, -0.065652, 0.004207, 0.083226, 0.072693, 0.060091, 0.008473, -0.077485, -0.174581, -0.174581
#*# 	-0.181219, -0.218177, -0.136573, -0.002819, 0.096217, 0.104209, 0.065656, 0.028484, -0.100087, -0.229352, -0.219268
#*# 	-0.249792, -0.249792, -0.153103, -0.008648, 0.109441, 0.129471, 0.092322, 0.053182, -0.036205, -0.162705, -0.162705
#*# 	-0.160814, -0.160814, -0.075318, 0.004056, 0.103543, 0.171101, 0.160630, 0.042424, -0.022386, -0.099283, -0.099283
#*# 	0.036348, 0.036348, 0.019079, 0.082029, 0.150454, 0.217913, 0.172989, 0.124600, 0.061019, 0.028743, 0.028743
#*# 	0.105592, 0.105592, 0.105592, 0.146292, 0.190108, 0.223553, 0.205470, 0.173104, 0.107437, 0.107437, 0.107437
#*# 	0.285733, 0.285733, 0.285733, 0.285733, 0.285733, 0.285733, 0.285733, 0.285733, 0.285733, 0.285733, 0.285733
#*# x_count = 11
#*# y_count = 11
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = -120.0
#*# max_x = 120.0
#*# min_y = -120.0
#*# max_y = 120.0
#*#
#*# [bed_mesh 90]
#*# version = 1
#*# points =
#*# 	  0.744580, 0.744580, 0.744580, 0.744580, 0.744580, 0.744580, 0.744580, 0.744580, 0.744580, 0.744580, 0.744580
#*# 	  0.539754, 0.539754, 0.539754, 0.459640, 0.370428, 0.327535, 0.272407, 0.216943, 0.210659, 0.210659, 0.210659
#*# 	  0.239032, 0.239032, 0.167706, 0.185071, 0.156105, 0.123484, 0.089239, 0.081487, 0.003424, -0.111883, -0.111883
#*# 	  0.020802, 0.020802, 0.022525, 0.063788, 0.088773, 0.063025, 0.076029, 0.019381, -0.065576, -0.215549, -0.215549
#*# 	  -0.142969, -0.142969, -0.083652, 0.008207, 0.086226, 0.078693, 0.058091, 0.016473, -0.087485, -0.168581, -0.168581
#*# 	  -0.136219, -0.169177, -0.101573, 0.019181, 0.117217, 0.116209, 0.075656, 0.029484, -0.085087, -0.219352, -0.206268
#*# 	  -0.225792, -0.225792, -0.130103, 0.020352, 0.120441, 0.138471, 0.108322, 0.063182, -0.019205, -0.145705, -0.145705
#*# 	  -0.118814, -0.118814, -0.055318, 0.030056, 0.135543, 0.188101, 0.181630, 0.058424, -0.016386, -0.084283, -0.084283
#*# 	  0.061348, 0.061348, 0.051079, 0.104029, 0.180454, 0.235913, 0.184989, 0.136600, 0.072019, 0.042743, 0.042743
#*# 	  0.159592, 0.159592, 0.159592, 0.182292, 0.216108, 0.252553, 0.229470, 0.198104, 0.145437, 0.145437, 0.145437
#*# 	  0.306733, 0.306733, 0.306733, 0.306733, 0.306733, 0.306733, 0.306733, 0.306733, 0.306733, 0.306733, 0.306733
#*# x_count = 11
#*# y_count = 11
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = -120.0
#*# max_x = 120.0
#*# min_y = -120.0
#*# max_y = 120.0
